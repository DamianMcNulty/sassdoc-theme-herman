// Herman Utilities
// ================


// Herman
// ------
/// A map of values to be exported to JSON.
/// Use the `herman-add` mixin to automatically populate
/// fonts, colors, sizes, and ratios.
/// @group sass-utilities
$herman: ();


// String Replace
// --------------
/// Return a string, with a substring replaced
/// @group sass-utilities
/// @access private
/// @param {String} $string -
///   The base string to be manipulated
/// @param {String} $old -
///   A sub-string to look for, and replace,
///   inside the base string
/// @param {String} $new -
///   A sub string to insert
///   in place of the `$old` string
/// @param {Boolean} $replace-all [false] -
///   Replace all instances of the `$old` string
///   or just the first instance?
/// @return {String} -
///   Return the base string,
///   with one or more instances of a substring replaced
@function _herman-str-replace(
  $string,
  $old,
  $new: null,
  $replace-all: false
) {
  $return: $string;
  $i: str-index($string, $old);
  $n: str-length($old);

  @if $string == $old {
    $return: $new;
  } @else if $i {
    $a: if($i > 1, str-slice($string, 1, $i - 1), '');
    $z: str-slice($string, $i + $n);

    @if $replace-all {
      $z: _herman-str-replace($z, $old, $new, true);
    }

    $return: $a + if($new, $new, '') + $z;
  }

  @return $return;
}


// Herman Inspect
// --------------
/// Convert any value into a json-export-ready string
/// @group sass-utilities
/// @access private
/// @param $value -
///   Any sass value to convert
/// @return {String} -
///   A string reprepesentation of the given value,
///   with leading zeros on numbers,
///   and quotes escaped for JSON
@function _herman-inspect(
  $value
) {
  $value: inspect($value);

  @if str-index($value, '.') == 1 {
    $value: '0' + $value;
  }

  @if str-index($value, '"') {
    $value: _herman-str-replace($value, '"', '\\"', true);
  }

  @return $value;
}


// Map Compile
// -----------
/// Get output values from a sass map,
/// using any function for compilation
/// @group sass-utilities
/// @access private
/// @param {Map} $map -
///   A sass map with values that need to be compiled,
///   such as Accoutrement Colors or Sizes with adjustments
/// @param {String | Function} $function -
///   The function (or function name) to use in compiling values,
///   such as Accoutrement `color` and `size` functions
/// @param {Arglist} $args… -
///   Pass in any additional arguments for the function
/// @return {String | Any} -
///   An updated map,
///   with values compiled by a third-party function
@function _herman-map-compile(
  $map,
  $function,
  $args...
) {
  $output: ();

  @each $key, $value in $map {
    // this is a workaround for a sass bug I thought was fixed…
    // https://github.com/sass/libsass/issues/1645#issuecomment-324102683
    $call: ($function, $value);
    $call: if(length($args) > 0, join($call, $args...), $call);

    $value: call($call...);
    $value: _herman-inspect($value);
    $output: map-merge($output, ($key: $value));
  }

  @return $output;
}


// Herman Add
// ----------
/// Add a map of colors, fonts, sizes, ratios, etc
/// to the `$herman` export map for JSON.
/// @group sass-utilities
/// @param {String} $key -
///   A key name for accessing this data in JSON —
///   should match the variable name,
///   unless otherwise set in the `@preview` annotation
/// @param {Map} $map -
///   A map of name/value pairs
/// @param {Arglist} $args… -
///   A function to use for compiling values before export,
///   and any additional arguments for the function
/// @output
///   Updated `$herman` map, ready for JSON export
@mixin herman-add(
  $key,
  $map,
  $args...
) {
  @if (length($args) > 0) {
    $map: _herman-map-compile($map, $args...);
  }

  $herman: map-merge($herman, ($key: $map)) !global;
}


// Accoutrement Add
// ----------------
/// Add [Accoutrement](http://oddbird.net/open-source/accoutrement/)
/// map-partials to both the Herman export map and
/// the appropriate global Accoutrement map variable –
/// e.g. colors are added to both `$herman` (compiled)
/// and `$colors` (raw).
/// @group sass-utilities
/// @param {String} $type -
///   The type of map being added,
///   e.g. `colors`, `fonts`, `sizes`, or `ratios`
///   (plural or singular).
/// @param {String} $key -
///   A key name for accessing this data in JSON —
///   should match the variable name,
///   unless otherwise set in the `@preview` annotation
/// @param {Map} $map -
///   A map of name/value pairs,
///   based on the Accoutrement syntax
/// @output
///   Updated `$herman` map, ready for JSON export
@mixin accoutrement-add(
  $type,
  $key,
  $map
) {
  $functions: (
    'color': 'color',
    'colors': 'color',
    'size': 'size',
    'sizes': 'size',
    'scale': 'size',
  );
  $call: map-get($functions, $type);
  $get: function-exists('get-function');
  $call: if($get and $call, get-function($call), $call);

  @if ($call == 'color') {
    $colors: map-merge($colors, $map) !global;
  } @else if ($call == 'size') {
    $sizes: map-merge($sizes, $map) !global;
  } @else if index('font' 'fonts', $type) {
    $fonts: map-merge($fonts, ($key: $map)) !global;
  } @else if index('ratio' 'ratios', $type) {
    $ratios: map-merge($ratios, $map) !global;
  }

  $args: ($key, $map);
  $args: if($call, append($args, $call), $args);

  @include herman-add($args...);
}
